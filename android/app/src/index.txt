import express from "express";
import { VertexAI } from "@google-cloud/vertexai";

const app = express();

// Cloud Run define el puerto vÃ­a variable de entorno PORT
const PORT = process.env.PORT || 8080;

app.use(express.json({ limit: "20mb" }));
app.use((req, res, next) => {
  res.header("Access-Control-Allow-Origin", "*");
  res.header("Access-Control-Allow-Headers", "Content-Type");
  res.header("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  if (req.method === "OPTIONS") return res.sendStatus(200);
  next();
});

const vertex = new VertexAI({
  project: process.env.GCP_PROJECT_ID || "gen-lang-client-0512040710",
  location: "us-central1",
});

const model = vertex.getGenerativeModel({ model: "gemini-1.5-pro" });

// Health check
app.get("/health", (req, res) => {
  res.json({ service: "photomaton-api", status: "healthy", version: "2.0.0" });
});

// Endpoint ejemplo
app.post("/api/v1/analyze-photo", async (req, res) => {
  try {
    const { image_base64, mime_type = "image/jpeg" } = req.body;
    if (!image_base64) return res.status(400).json({ error: "image_base64 required" });

    const result = await model.generateContent({
      contents: [{
        role: "user",
        parts: [
          { inlineData: { mimeType: mime_type, data: image_base64 } },
          { text: "Analyze this image in detail. Describe subjects, colors, composition, mood and style." }
        ]
      }]
    });

    const text = result.response.candidates[0].content.parts.find(p => p.text)?.text;
    res.json({ status: "success", analysis: text });

  } catch (e) {
    console.error("analyze error:", e.message);
    res.status(500).json({ error: e.message });
  }
});

// Escucha en el puerto de Cloud Run
app.listen(PORT, "0.0.0.0", () => console.log(`Server listening on port ${PORT}`));